---
description: Next.js API Route 定义规范，包括直接使用 Prisma 操作数据库和统一使用 ApiResponseBuilder 返回。
globs: apps/server/src/app/api/**/*.ts
alwaysApply: false
---

# Next.js API Route 定义规范

本规范旨在确保 `flower-shop` 项目服务器端（Next.js）的 API 路由实现保持高度一致，简化分层结构，并统一响应格式。

## 1. 核心原则

- **直接数据库访问**：在 API Route 文件中直接使用 `@/lib/prisma` 实例进行数据库操作。除非业务逻辑极其复杂，否则不需要引入额外的 Service 层。
- **统一响应格式**：所有请求必须通过 `@/lib/api-response` 中的 `ApiResponseBuilder` 返回。
- **数据校验**：使用 `zod` 定义 Schema 并对请求体（body）或查询参数（query）进行校验。

## 2. 代码实现规范

### 2.1 请求处理

- 使用 `NextRequest` 类型声明请求参数。
- 所有的业务逻辑应包裹在 `try...catch` 块中。

### 2.2 响应处理

- **成功响应**：调用 `ApiResponseBuilder.success('trace-id', data)`。
- **错误响应**：调用 `ApiResponseBuilder.error('trace-id', message, statusCode, details)`。
- **校验失败**：当 `zod` 校验失败时，返回 400 状态码及详细错误信息。

### 2.3 数据库操作

- 引入 Prisma：`import prisma from '@/lib/prisma';`。
- 直接在路由处理函数中调用 `prisma.model.method()`。

## 3. 代码示例模板

```typescript
import { NextRequest } from 'next/server';
import { z } from 'zod';
import { ApiResponseBuilder } from '@/lib/api-response';
import prisma from '@/lib/prisma';

// 1. 定义校验 Schema
const schema = z.object({
  name: z.string().min(1, '名称不能为空'),
  // ... 其他字段
});

export async function POST(request: NextRequest) {
  try {
    // 2. 解析与校验数据
    const body = await request.json();
    const validation = schema.safeParse(body);

    if (!validation.success) {
      return ApiResponseBuilder.error(
        'trace-id',
        '数据校验失败',
        400,
        Object.entries(validation.error.flatten().fieldErrors).map(([field, errors]) => ({
          field,
          message: errors?.[0] || '验证失败'
        }))
      );
    }

    // 3. 直接使用 Prisma 操作数据库
    const result = await prisma.yourModel.create({
      data: validation.data
    });

    // 4. 统一返回成功响应
    return ApiResponseBuilder.success('trace-id', result);

  } catch (error: any) {
    console.error('操作失败:', error);
    // 5. 统一返回错误响应
    return ApiResponseBuilder.error('trace-id', '操作失败', 500, [
      { message: error.message }
    ]);
  }
}
```

## 4. 路由约定

- 微信小程序专用接口建议放置在 `apps/server/src/app/api/wx/` 目录下。
- 公共接口建议放置在 `apps/server/src/app/api/public/` 目录下。
- 管理员接口建议放置在 `apps/server/src/app/api/admin/` 目录下
- 接口路径应遵循 RESTful 风格或业务功能模块化。
