# 行动计划：数据采集与存储全方位升级

- [x] 修复 `qiniu.ts` 上传服务中的 Bug
- [x] 升级 `POST /api/bloggers` 接口，支持完整数据（含作品）的接收与处理
- [x] 实现图片从 URL 抓取并上传至七牛云的逻辑
- [x] 更新 `Prisma` 事务，实现博主、帖子、统计数据的原子化“更新或创建” (`Upsert`)
- [x] 升级前端类型定义 (`types.ts`) 以适配新数据结构
- [x] 升级 `content.js`，通过注入脚本方式成功采集完整数据
- [x] 修复 Web App 自动回填功能
- [x] 修复插件与Web App的通信问题 (postMessage targetOrigin)
- [x] 统一开发环境URL，适配HTTPS代理
- [x] 修复Web App因数据结构不匹配导致的无法回填问题
- [x] 完善博主详情页，增加数据趋势图

---

## **核心API调试与优化日志**

在核心的 `POST /api/bloggers` 接口开发和联调过程中，我们遇到并解决了一系列深层次的性能和数据一致性问题，关键历程记录如下：

1. **问题：Prisma 事务超时 (`Transaction already closed`)**
    - **现象**: 在事务内部循环处理多篇笔记时，每次循环都包含一个网络请求（上传封面图到OSS），导致总耗时超过Prisma默认的5秒超时限制。
    - **解决方案**: **先上传，后入库**。将所有耗时的文件上传操作（头像和所有笔记封面）全部移到数据库事务之外，并通过 `Promise.all` 并行执行以缩短总时间。待所有URL都获取完毕后，再启动一个只包含纯数据库操作的、轻量化的事务，从而彻底规避超时风险。

2. **问题：OSS 文件重复上传**
    - **现象**: 每次调用接口都会重新上传头像和封面，浪费存储空间和上传时间。
    - **解决方案**: **文件名与实体ID挂钩**。重构 `UploadService`，确保上传到OSS的文件名直接使用其实体ID（如博主的 `redId` 或笔记的 `note.id`），实现了上传操作的幂等性，从根本上解决了重复上传问题。

3. **问题：Prisma 唯一性约束失败 (`Unique constraint failed`)**
    - **现象**: 在使用 `createMany` 批量创建帖子时，数据库报错，提示 `postId` 重复。
    - **分析**: 定位到问题是由于插件从前端页面采集的数据本身就可能包含重复的帖子，而此前的逻辑未能处理这种情况。
    - **解决方案**: **服务端数据清洗**。在执行数据库操作之前，增加了一个关键的预处理步骤：对从客户端传来的 `notes` 数组，基于 `note.id` 进行去重。这确保了无论上游数据如何，进入数据库的都是干净、唯一的数据。

**所有计划任务已完成！**
