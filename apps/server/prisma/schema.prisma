generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. æ ¸å¿ƒç§Ÿæˆ·ä½“ç³»
// ==========================================

model Store {
  id            String   @id @default(cuid())
  name          String   // åº—é“ºåç§° (å¦‚: èŠ±é—´é‡Œ)
  code          String   @unique // åº—é“ºè‹±æ–‡æ ‡è¯† (å¦‚: H)ï¼Œç”¨äºç”Ÿæˆå±•ç¤ºç¼–å·

  // --- å¾®ä¿¡å°ç¨‹åºé…ç½® ---
  appId         String   @unique // å°ç¨‹åº AppID (å¤šç§Ÿæˆ·è·¯ç”±æ ¸å¿ƒ)
  appSecret     String?  // å°ç¨‹åº AppSecret

  // --- æ”¯ä»˜é…ç½® (é¢„ç•™) ---
  mchId         String?  // å•†æˆ·å·
  mchKey        String?  // æ”¯ä»˜å¯†é’¥ V3

  // --- ç§Ÿæˆ·çŠ¶æ€ ---
  isActive      Boolean  @default(true) // ç§Ÿæˆ·çŠ¶æ€å¼€å…³

  // --- å…³è”å…³ç³» ---
  users           User[]
  products        Product[]
  productStyles   ProductStyle[]   
  storeCategories StoreCategory[]  
  loginTickets    LoginTicket[]
  channels        Channel[]        

  createdAt     DateTime @default(now())
  @@map("stores")
}

// ==========================================
// 2. ç”¨æˆ·ä¸æƒé™ä½“ç³»
// ==========================================

model User {
  id          String   @id @default(cuid())

  // --- ç§Ÿæˆ·éš”ç¦» ---
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])

  displayId   String   @unique // å‘˜å·¥å±•ç¤ºID (å¦‚: H-1001)

  // --- èº«ä»½è®¤è¯ ---
  openid      String?  // å¾®ä¿¡ OpenID (å°ç¨‹åºç™»å½•æ ¸å¿ƒ)
  password    String?  // å¯†ç  (å¤‡ç”¨ï¼ŒåŠ å¯†å­˜å‚¨)
  role        String   @default("USER") // è§’è‰²: USER(å‘˜å·¥), ADMIN(åº—é•¿)

  // --- åŸºç¡€ä¿¡æ¯ ---
  nickname    String?  // æ˜µç§°
  avatar      String?  // å¤´åƒ
  phone       String?  // æ‰‹æœºå·
  gender      Int      @default(0)
  birthday    String?
  city        String?
  province    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([openid, storeId]) // åŒä¸€ä¸ªå¾®ä¿¡ç”¨æˆ·åœ¨ä¸åŒåº—é“ºå¯ä»¥æ˜¯ä¸åŒèº«ä»½
  @@map("users")
}

model LoginTicket {
  id        String   @id @default(cuid())
  storeId   String

  store     Store    @relation(fields: [storeId], references: [id])

  scene     String?  // æ‰«ç åœºæ™¯å€¼
  status    String   @default("PENDING") // PENDING, SCANNED, CONFIRMED, EXPIRED

  openid    String?  // æ‰«ç è€…çš„ OpenID
  userId    String?  // ç¡®è®¤åçš„ UserID
  token     String?  @db.Text // ç™»å½•æˆåŠŸåç­¾å‘çš„ Token

  createdAt DateTime @default(now())
  expiresAt DateTime
  updatedAt DateTime @updatedAt

  @@map("login_tickets")
}

// ==========================================
// 3. å•†å“ä¸ SKU ä½“ç³» (SPU-SKU Architecture)
// ==========================================

// [æ”¹å] ç‰©ç†æ¬¾å¼è¡¨ (åŸ Category)
// å¯¹åº”ç¾å›¢çš„ "æ¬¾å¼"ï¼šèŠ±æŸã€èŠ±ç›’ã€èŠ±ç¯®
model ProductStyle {
  id          String    @id @default(cuid())
  storeId     String
  store       Store     @relation(fields: [storeId], references: [id])

  name        String    // å¦‚: "éŸ©å¼èŠ±æŸ", "æ‰‹æèŠ±ç›’", "å¼€ä¸šèŠ±ç¯®"
  sortOrder   Int       @default(0)

  products    Product[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([storeId, name])
  @@map("product_styles") 
}

// SPU (Standard Product Unit) - å•†å“é›†åˆè¡¨
model Product {
  id            String   @id @default(cuid())
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])

  displayId     String   @unique // å•†å“å±•ç¤ºçŸ­å·

  // --- SPU åŸºç¡€ä¿¡æ¯ ---
  name          String   // å•†å“å¤§åï¼Œå¦‚ "éŸ©å¼ç¢å†°è“"
  description   String?  @db.Text
  images        Json     // ä¸»å›¾åˆ—è¡¨
  status        String   @default("ACTIVE") // SPU çº§æ€»å¼€å…³

  // --- æ ¸å¿ƒå˜æ›´ï¼šåº“å­˜ä¸ä»·æ ¼ä¸‹æ”¾è‡³ Variant ---
  // [æ³¨æ„] åŸ stock, costPrice, storeCode å·²ç§»é™¤ï¼Œè¯·æŸ¥é˜… ProductVariant è¡¨

  // --- å±æ€§ (ä»ç¾å›¢ JSON æå–çš„ SPU çº§å±æ€§) ---
  mainFlower    String?  // ä¸»èŠ±æ
  colorSeries   String?  // è‰²ç³»
  materials     Json     // èŠ±æé…æ–¹ (BOM)

  // --- å…³ç³» ---
  styleId       String?
  style         ProductStyle? @relation(fields: [styleId], references: [id])
  
  // ğŸŸ¢ [åˆ†ç±»] ä¾ç„¶æŒ‚åœ¨ SPU ä¸Šï¼Œå› ä¸ºåˆ†ç±»æ˜¯æ‰“ç»™æ•´ä¸ªå•†å“çš„
  categories    CategoryOnProduct[] 

  // ğŸŸ¡ [æ¸ é“] SPU çº§æ¸ é“æ§åˆ¶ (ä¸Šä¸‹æ¶/å±•ç¤ºä»·)
  channels      ProductChannel[] 

  // ğŸ”´ [æ–°å¢] å…·ä½“çš„è§„æ ¼/SKU (19æ, 33æ...)
  variants      ProductVariant[]

  // --- æ—§æ•°æ®ä¿ç•™ ---
  sortOrder     Int      @default(0) // å…¨å±€é»˜è®¤æ’åº

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("products")
}

// [æ–°å¢] è§„æ ¼/SKU æ¨¡å‹ - å¯¹åº”ç¾å›¢çš„ "skus" æ•°ç»„
model ProductVariant {
  id            String   @id @default(cuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // --- æ ¸å¿ƒï¼šåº—å†…ç  (ä½ çš„å”¯ä¸€é”šç‚¹) ---
  // [å˜æ›´] ä» Product è¡¨ç§»åˆ°äº†è¿™é‡Œï¼Œå¯¹åº”æˆªå›¾é‡Œçš„ "3003101183112"
  // è¿™æ˜¯ SKU çº§åˆ«çš„å”¯ä¸€é”šç‚¹ï¼Œè„šæœ¬åŒæ­¥å…¨é å®ƒ
  storeCode     String?  

  // --- è§„æ ¼ä¿¡æ¯ ---
  name          String   // "19æ", "33æ", "æ ‡å‡†æ¬¾"
  stock         Int      @default(0) // ç‰©ç†åº“å­˜ (å¯¹åº”æˆªå›¾é‡Œçš„ 99)
  
  // --- å†…éƒ¨åŸºå‡†ä»· ---
  costPrice     Decimal  @default(0.00) @db.Decimal(10, 2)
  price         Decimal  @default(0.00) @db.Decimal(10, 2) // å†…éƒ¨é›¶å”®æŒ‡å¯¼ä»·

  // --- æ¸ é“å·®å¼‚åŒ–æ•°æ® (JSON) ---
  // ç»“æ„ç¤ºä¾‹ï¼š
  // {
  //   "meituan": { "price": 218, "externalId": "300310...", "discount_price": 178 },
  //   "douyin": { "price": 199 }
  // }
  channelData   Json?    

  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([productId, name]) // åŒä¸€ä¸ªå•†å“ä¸‹ä¸èƒ½æœ‰ä¸¤ä¸ª "19æ"
  @@index([storeCode]) // åŠ é€ŸåŒæ­¥è„šæœ¬æŸ¥æ‰¾
  @@map("product_variants")
}

// ==========================================
// 4. æ¸ é“åˆ†å‘ä½“ç³» (Distribution)
// ==========================================

model Channel {
  id        String   @id @default(cuid())
  storeId   String   // æ”¯æŒå¤šåº—å¤šæ¸ é“é…ç½®
  store     Store    @relation(fields: [storeId], references: [id])

  code      String   // æ¸ é“ä»£å·: "meituan", "douyin", "jd", "wechat_mini"
  name      String   // æ¸ é“åç§°: "ç¾å›¢ç‚¹è¯„", "æŠ–éŸ³å›¢è´­"
  icon      String?  // æ¸ é“å›¾æ ‡ URL
  
  // --- æ¸ é“é…ç½® ---
  config    Json?    // é¢„ç•™: API Key, App Secret ç­‰

  // å…³è”
  products  ProductChannel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, code]) // åŒä¸€å®¶åº—ä¸èƒ½æœ‰ä¸¤ä¸ª "meituan"
  @@map("channels")
}

// å•†å“-æ¸ é“ å…³è”è¡¨ (SPU Level)
// æ ¸å¿ƒç”¨é€”ï¼šåˆ—è¡¨é¡µæé€Ÿå±•ç¤ºã€æ•´ä½“ä¸Šä¸‹æ¶
model ProductChannel {
  id          String   @id @default(cuid())
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  channelId   String
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // --- è¯­ä¹‰å˜åŒ–åŒº ---
  
  // [å±•ç¤ºä»·] ç”¨äºå°ç¨‹åºåˆ—è¡¨é¡µå±•ç¤º "ï¿¥199 èµ·"
  // åŒæ­¥è„šæœ¬åœ¨å†™å…¥ SKU ä»·æ ¼æ—¶ï¼Œåº”é¡ºä¾¿æŠŠæœ€ä½ä»·æ›´æ–°åˆ°è¿™é‡Œ
  price       Decimal  @default(0.00) @db.Decimal(10, 2) 
  
  // [SPU ID] å¯¹åº”ç¾å›¢çš„ SPU ID (é SKU ID)
  externalId  String?  
  
  // [æ€»å¼€å…³] å³ä½¿ SKU æœ‰åº“å­˜ï¼Œå¦‚æœè¿™é‡Œæ˜¯ falseï¼Œæ•´ä¸ªå•†å“åœ¨è¯¥æ¸ é“ä¸‹æ¶
  isListed    Boolean  @default(false) 

  // [åŒæ­¥çŠ¶æ€] ç”¨äºè„šæœ¬ç›‘æ§
  syncStatus  String?  // "SYNCED", "PENDING", "ERROR"
  lastSyncAt  DateTime? // ä¸Šæ¬¡åŒæ­¥æ—¶é—´

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // å¤åˆå”¯ä¸€ç´¢å¼•ï¼šç¡®ä¿ä¸€ä¸ªå•†å“åœ¨ä¸€ä¸ªæ¸ é“åªæœ‰ä¸€æ¡è®°å½•
  @@unique([productId, channelId])
  @@index([externalId]) 
  @@map("product_channels")
}

// ==========================================
// 5. è¥é”€ä¸å±•ç¤ºä½“ç³» (Showcase)
// ==========================================

model StoreCategory {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])

  name        String   // æ ¸å¿ƒé”šç‚¹ï¼šæ—¢æ˜¯å±•ç¤ºåï¼Œä¹Ÿæ˜¯è·¨å¹³å°åŒæ­¥çš„åŒ¹é…é”®
  icon        String?
  sortOrder   Int      @default(0)
  
  // æ€»å¼€å…³ï¼šå…³æ‰åæ‰€æœ‰æ¸ é“éƒ½ä¸æ˜¾ç¤º
  isVisible   Boolean  @default(true) 

  // æ¸ é“å¯è§æ€§æ§åˆ¶ (Channel Visibility)
  // å¦‚æœä¸å­˜ï¼Œé»˜è®¤å…¨æ¸ é“å¯è§ã€‚å¦‚æœå­˜äº† ['wechat_mini']ï¼Œåˆ™ç¾å›¢/æŠ–éŸ³ä¸æ˜¾ç¤ºã€‚
  visibleChannels  Json?  

  // --- å¤šçº§åˆ†ç±» ---
  parentId    String?  // çˆ¶çº§åˆ†ç±»ID
  parent      StoreCategory?   @relation("SubCategories", fields: [parentId], references: [id], onDelete: Cascade)
  children    StoreCategory[]  @relation("SubCategories")

  products    CategoryOnProduct[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // å¤åˆå”¯ä¸€ç´¢å¼•ï¼šç¡®ä¿åŒä¸€å®¶åº—é‡Œæ²¡æœ‰é‡åçš„åˆ†ç±»
  @@unique([storeId, name]) 
  @@map("store_categories") 
}

model CategoryOnProduct {
  productId   String
  product     Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  categoryId  String
  category    StoreCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  sortOrder   Int    @default(0) // åœ¨è¯¥åˆ†ç±»ä¸‹çš„è‡ªå®šä¹‰æ’åº

  @@id([productId, categoryId])
  @@map("categories_on_products")
}

// ==========================================
// 6. åŸºç¡€è®¾æ–½
// ==========================================

// å…¨å±€æµæ°´å· (ç”¨äºç”ŸæˆçŸ­ID)
model SystemSequence {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())

  @@map("system_sequences")
}