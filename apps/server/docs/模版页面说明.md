# 后台管理页面开发规范

## 目录结构规范

### 标准三页面模式

所有管理模块都应遵循以下目录结构：

```
src/app/dashboard/[模块名]/
├── page.tsx                    # 列表页面 (主页面)
├── new/
│   └── page.tsx               # 新建页面 (重定向到编辑页面)
└── [id]/
    └── page.tsx               # 编辑页面 (同时处理新建和编辑)
```

**设计原则**：

- **单一职责**：每个文件有明确的功能定位
- **最大复用**：新建页面完全复用编辑页面
- **路由驱动**：通过 URL 参数区分页面状态

### 新建页面模板

`new/page.tsx` 始终保持简洁，仅做重定向：

```typescript
"use client"

import [ModuleName]EditPage from "../[id]/page"

export default function New[ModuleName]Page() {
  return <[ModuleName]EditPage />
}
```

## 代码组织规范

### 1. 导入顺序

```typescript
// 1. React 相关
import { useState, useEffect } from "react"
import { useRouter, useParams } from "next/navigation"

// 2. UI 组件库
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"
// ... 其他 UI 组件

// 3. 图标
import { ArrowLeft, Save, Loader2 } from 'lucide-react'

// 4. 自定义组件
import { ImageUpload } from "@/components/image-upload"

// 5. 工具库
import { http } from '@/lib/request'
import { useToast } from '@/hooks/use-toast'
```

### 2. 类型定义规范

```typescript
// 数据库实体类型 (与后端保持一致)
export interface [EntityName] {
  id: number;
  // 基础字段
  name: string;
  description?: string;
  isActive: boolean;
  // 时间戳字段
  createdAt: string;
  updatedAt: string;
}

// 表单数据类型 (剔除自动生成字段)
interface [EntityName]FormData {
  name: string
  description: string
  isActive: boolean
  // ... 其他可编辑字段
}

// API 响应类型 (列表页面用)
interface ApiResponse {
  data: [EntityName][];
  total: number;
  page: number;
  limit: number;
  totalPages: number;
}
```

### 3. 组件结构模板

```typescript
export default function [ModuleName]EditPage() {
  // 路由和工具 hooks
  const router = useRouter()
  const params = useParams()
  const { toast } = useToast()

  // 状态判断
  const isNew = params.id === "new"

  // 状态管理
  const [formData, setFormData] = useState<[EntityName]FormData>(initialFormData)
  const [loading, setLoading] = useState(false)
  const [initialLoading, setInitialLoading] = useState(!isNew)

  // 数据获取
  const fetch[EntityName] = async (id: string) => { /* ... */ }

  // 副作用
  useEffect(() => {
    if (!isNew && params.id) {
      fetch[EntityName](params.id as string)
    }
  }, [isNew, params.id])

  // 事件处理
  const handleInputChange = (field: keyof [EntityName]FormData, value: any) => { /* ... */ }
  const handleSave = async () => { /* ... */ }

  // 加载状态
  if (initialLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <Loader2 className="h-8 w-8 animate-spin" />
        <span className="ml-2">加载中...</span>
      </div>
    )
  }

  // 渲染
  return (
    <div className="space-y-6">
      {/* 页面头部 */}
      {/* 表单内容 */}
    </div>
  )
}
```

## 状态管理规范

### 1. 模式识别

```typescript
const isNew = params.id === "new"  // 标准判断逻辑
const [initialLoading, setInitialLoading] = useState(!isNew)  // 优化加载体验
```

### 2. 条件性数据获取

```typescript
useEffect(() => {
  if (!isNew && params.id) {
    fetchData(params.id as string)
  }
}, [isNew, params.id])
```

### 3. 统一的表单处理

```typescript
const handleInputChange = (field: keyof FormData, value: any) => {
  setFormData((prev) => ({ ...prev, [field]: value }))
}
```

## UI/UX 一致性规范

### 1. 响应式布局模板

```typescript
<div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
  {/* 左侧主要内容 (2/3宽度) */}
  <div className="lg:col-span-2 space-y-6">
    {/* 表单卡片 */}
  </div>

  {/* 右侧状态信息 (1/3宽度) */}
  <div className="space-y-6">
    {/* 状态卡片 */}
  </div>
</div>
```

### 2. 页面头部模板

```typescript
<div className="flex items-center justify-between">
  <div className="flex items-center gap-4">
    <Button variant="outline" size="icon" onClick={() => router.back()}>
      <ArrowLeft className="h-4 w-4" />
    </Button>
    <div className="flex items-center gap-2">
      <[Icon] className="h-6 w-6" />
      <div>
        <h1 className="text-3xl font-bold tracking-tight">
          {isNew ? "新建[模块]" : "编辑[模块]"}
        </h1>
        {!isNew && (
          <p className="text-muted-foreground">[模块]ID: {params.id}</p>
        )}
      </div>
    </div>
  </div>
  <div className="flex items-center gap-2">
    <Button variant="outline" onClick={() => router.back()}>
      取消
    </Button>
    <Button onClick={handleSave} disabled={loading}>
      <Save className="mr-2 h-4 w-4" />
      {loading ? "保存中..." : "保存"}
    </Button>
  </div>
</div>
```

### 3. 卡片组织规范

```typescript
<Card>
  <CardHeader>
    <CardTitle>卡片标题</CardTitle>
    {/* 可选的描述文本 */}
    <p className="text-sm text-muted-foreground">
      描述信息
    </p>
  </CardHeader>
  <CardContent className="space-y-4">
    {/* 表单字段 */}
  </CardContent>
</Card>
```

### 4. 表单字段模板

```typescript
<div className="space-y-2">
  <Label htmlFor="fieldName">字段标签 *</Label>
  <Input
    id="fieldName"
    value={formData.fieldName}
    onChange={(e) => handleInputChange("fieldName", e.target.value)}
    placeholder="请输入..."
  />
  <p className="text-sm text-muted-foreground">
    字段说明
  </p>
</div>
```

## 错误处理规范

### 1. 表单验证模板

```typescript
const handleSave = async () => {
  // 1. 基础字段验证
  if (!formData.name.trim()) {
    toast({
      title: '验证失败',
      description: '名称不能为空',
      variant: 'destructive'
    })
    return
  }

  // 2. 数据类型转换
  // 3. 业务逻辑验证
  // 4. API 调用

  setLoading(true)
  try {
    if (isNew) {
      // 新建逻辑
    } else {
      // 更新逻辑
    }
  } catch (error: any) {
    toast({
      title: isNew ? '创建失败' : '更新失败',
      description: error.message || '请稍后重试',
      variant: 'destructive'
    })
  } finally {
    setLoading(false)
  }
}
```

### 2. 统一的错误提示

```typescript
// 成功提示
toast({
  title: '操作成功',
  description: '具体成功信息'
})

// 错误提示
toast({
  title: '操作失败',
  description: error.message || '请稍后重试',
  variant: 'destructive'
})
```

## 图片上传规范

### 1. ImageUpload 组件配置

```typescript
// 单张图片
<ImageUpload
  value={formData.coverImage ? [formData.coverImage] : []}
  onChange={(files) => handleUpdateFile("coverImage", files)}
  maxFiles={1}
  aspectRatio="1/1"
  width={150}
  height={150}
/>

// 多张图片
<ImageUpload
  value={formData.images}
  onChange={(files) => handleUpdateFile("images", files)}
  maxFiles={5}
  aspectRatio="3/2"
  width={200}
  height={133}
/>
```

### 2. 文件处理模板

```typescript
const handleUpdateFile = async (field: keyof FormData, value: (string | File)[]) => {
  if (!value || value.length === 0) {
    setFormData((prev) => ({ ...prev, [field]: [] }))
    return
  }

  const existingUrls = value.filter((item): item is string => typeof item === 'string')
  const newFiles = value.filter((item): item is File => item instanceof File)

  if (newFiles.length === 0) {
    setFormData((prev) => ({ ...prev, [field]: existingUrls }))
    return
  }

  try {
    // 上传逻辑
    toast({
      title: '正在上传',
      description: `正在上传 ${newFiles.length} 张图片...`
    })

    // 批量上传处理
    // 成功后更新状态

    toast({
      title: '上传成功',
      description: `成功上传 ${uploadedUrls.length} 张图片`
    })
  } catch (error: any) {
    setFormData((prev) => ({ ...prev, [field]: existingUrls }))
    toast({
      title: '上传失败',
      description: error.message || '图片上传失败，请重试',
      variant: 'destructive'
    })
  }
}
```

## 列表页面规范

### 1. 状态管理结构

```typescript
// 数据状态
const [items, setItems] = useState<EntityType[]>([])
const [loading, setLoading] = useState(false)
const [total, setTotal] = useState(0)

// 筛选状态
const [searchTerm, setSearchTerm] = useState('')
const [statusFilter, setStatusFilter] = useState('all')

// 表格状态
const [selectedRows, setSelectedRows] = useState<number[]>([])
const [sortConfig, setSortConfig] = useState<{
  key: keyof EntityType | null;
  direction: 'asc' | 'desc';
}>({
  key: 'updatedAt',
  direction: 'desc'
})
const [currentPage, setCurrentPage] = useState(1)
const [pageSize, setPageSize] = useState(10)
```

### 2. 筛选区域模板

```typescript
<Card>
  <CardHeader>
    <CardTitle className='flex items-center gap-2'>
      <Filter className='h-5 w-5' />
      筛选条件
    </CardTitle>
  </CardHeader>
  <CardContent className='space-y-4'>
    <div className='grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4'>
      {/* 搜索框 */}
      <div className='space-y-2'>
        <Label htmlFor='search'>搜索</Label>
        <div className='relative'>
          <Search className='absolute left-2 top-2.5 h-4 w-4 text-muted-foreground' />
          <Input
            id='search'
            placeholder='搜索...'
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className='pl-8'
          />
        </div>
      </div>

      {/* 其他筛选条件 */}
    </div>
  </CardContent>
</Card>
```

### 3. 批量操作模板

```typescript
<div className='flex items-center gap-2'>
  {selectedRows.length > 0 && (
    <>
      <span className='mr-2 text-sm text-muted-foreground'>
        已选择 {selectedRows.length} 个项目
      </span>
      <Button variant='outline' size='sm' disabled={loading}>
        <Edit className='mr-2 h-4 w-4' />
        批量编辑
      </Button>
      <AlertDialog>
        <AlertDialogTrigger asChild>
          <Button variant='destructive' size='sm' disabled={loading}>
            <Trash2 className='mr-2 h-4 w-4' />
            批量删除
          </Button>
        </AlertDialogTrigger>
        {/* 删除确认对话框 */}
      </AlertDialog>
    </>
  )}
</div>
```

## 命名规范

### 1. 文件命名

- 页面文件：`page.tsx`
- 组件文件：`PascalCase.tsx`
- 工具文件：`camelCase.ts`

### 2. 变量命名

- 状态变量：`camelCase`
- 常量：`UPPER_SNAKE_CASE`
- 类型：`PascalCase`

### 3. 函数命名

- 事件处理：`handle[Action]`
- 数据获取：`fetch[Entity]`
- 工具函数：`[verb][Noun]`

## 性能优化规范

### 1. 条件渲染

```typescript
{isCondition && <Component />}
```

### 2. 列表优化

```typescript
const memoizedList = useMemo(() => {
  // 筛选和排序逻辑
}, [dependencies])
```

### 3. 防抖搜索

```typescript
const debouncedSearch = useMemo(
  () => debounce((term: string) => {
    // 搜索逻辑
  }, 300),
  []
)
```

## 可访问性规范

### 1. 语义化标签

- 使用适当的 `Label` 组件
- 为表单字段提供 `htmlFor` 属性
- 使用 `aria-label` 描述按钮功能

### 2. 键盘导航

- 确保所有交互元素可通过键盘访问
- 提供合理的 tab 顺序

### 3. 加载状态

- 提供明确的加载指示器
- 禁用加载期间的交互元素

通过遵循以上规范，可以确保整个后台管理系统的代码风格一致、用户体验统一、维护成本降低。
