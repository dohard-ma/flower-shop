# 产品列表页面逻辑说明

## 数据获取逻辑

### 1. 普通产品列表获取 (`fetchProducts`)

- **用途**：获取所有产品（分页查询）
- **触发时机**：
  - 初始加载（无分享ID时）
  - 筛选条件变化（款式、色系）
  - 取消"为您推荐"时
  - 滚动加载更多
- **查询参数**：
  - `page`: 页码
  - `limit`: 每页数量（10）
  - `style`: 款式筛选（可选）
  - `colorSeries`: 色系筛选（可选）
  - `search`: 搜索关键词（可选）
- **返回**：分页的产品列表

### 2. 分享产品获取 (`fetchSharedProducts`)

- **用途**：通过ID列表获取指定的分享产品
- **触发时机**：
  - URL中有 `shared` 参数时（首次加载）
  - 用户点击"为您推荐"按钮时
- **查询参数**：
  - `ids`: 产品ID列表（逗号分隔）
- **返回**：分享的产品列表（不分页）

## 筛选逻辑（支持叠加筛选）

### 筛选层级

筛选分为两层，支持叠加：

**第一层：数据源筛选**

- **"我喜欢"** (`showLikedOnly`): 客户端筛选，只显示喜欢的商品
- **"为您推荐"** (`showSharedOnly`): 通过 `fetchSharedProducts` 获取分享的商品

**第二层：款式/色系筛选**

- **在普通模式下**: 通过 API 参数查询（数据层筛选）
- **在"我喜欢"/"为您推荐"模式下**: 客户端前端过滤（支持叠加）

### 筛选组合示例

- 普通模式 + 款式"花束" → API查询所有花束
- "为您推荐" + 款式"花束" → 从推荐的商品中前端过滤出花束
- "我喜欢" + 色系"红" → 从喜欢的商品中前端过滤出红色系

## 状态管理

### 关键状态

- `products`: 当前加载的产品列表（来自API）
- `showLikedOnly`: 是否只显示"我喜欢"
- `showSharedOnly`: 是否只显示"为您推荐"
- `sharedProductIds`: 分享的产品ID集合（从URL解析）
- `selectedStyle`: 选中的款式
- `selectedColor`: 选中的色系

### 状态规则

1. **"我喜欢"和"为您推荐"互斥**：不能同时激活
2. **款式/色系支持叠加**：
   - 可以在"我喜欢"或"为您推荐"基础上，进一步筛选款式/色系
   - 激活"我喜欢"或"为您推荐"时，会清除款式/色系（重新开始）
   - 在"我喜欢"/"为您推荐"模式下选择款式/色系，**不会**退出该模式，而是叠加筛选

## 初始化流程

### 场景1：普通访问（无分享ID）

1. `mounted` 变为 `true`
2. 调用 `fetchProducts(1, false)` 获取第一页产品
3. 显示所有产品

### 场景2：带分享ID访问

1. `mounted` 变为 `true`
2. 解析URL中的 `shared` 参数
3. 设置 `sharedProductIds` 和 `showSharedOnly = true`
4. 调用 `fetchSharedProducts(ids)` 获取分享产品
5. 显示分享的产品

## 用户操作流程

### 点击"为您推荐"按钮

- **如果当前未激活**（激活推荐）：
  1. 设置 `showSharedOnly = true`，`showLikedOnly = false`
  2. 清除款式和色系筛选（重新开始）
  3. 调用 `fetchSharedProducts(ids)` 获取分享产品
  4. 显示分享的产品

- **如果当前已激活**（取消推荐）：
  1. 设置 `showSharedOnly = false`
  2. 清空 `products` 数组
  3. 重置分页状态
  4. 调用 `fetchProducts(1, false)` 获取普通产品（带当前款式/色系筛选）

### 点击"我喜欢"按钮

- **如果当前未激活**（激活喜欢）：
  1. 设置 `showLikedOnly = true`，`showSharedOnly = false`
  2. 清除款式和色系筛选（重新开始）
  3. 不请求API，客户端过滤显示喜欢的商品

- **如果当前已激活**（取消喜欢）：
  1. 设置 `showLikedOnly = false`
  2. 清空 `products` 数组
  3. 重置分页状态
  4. 调用 `fetchProducts(1, false)` 获取普通产品（带当前款式/色系筛选）

### 选择款式/色系

**在普通模式下**：

1. 设置对应的筛选值
2. 取消"我喜欢"（保留"为您推荐"不会影响）
3. 清空 `products` 数组（如果不在推荐/喜欢模式）
4. 由 useEffect 调用 `fetchProducts(1, false)` 重新获取

**在"我喜欢"/"为您推荐"模式下**：

1. 设置对应的筛选值
2. **保持当前模式**（不退出）
3. 客户端前端过滤，立即显示结果
4. **不触发 API 请求**

## 滚动加载更多

- **条件**：只在普通列表模式下工作（非"我喜欢"、非"为您推荐"）
- **逻辑**：滚动到底部时，调用 `fetchProducts(nextPage, true)` 追加数据

## 重要实现细节

### 数据清空策略

为了避免在模式切换时显示不匹配的旧数据，在以下场景会立即清空 `products` 数组：

1. **取消"为您推荐"或"我喜欢"**：
   - 切换回普通模式时立即 `setProducts([])`
   - 然后调用 `fetchProducts` 加载普通列表

2. **在普通模式下选择款式/色系**：
   - 如果当前不在推荐/喜欢模式，点击时立即 `setProducts([])`
   - useEffect 监听到筛选条件变化后重新加载数据

3. **useEffect 中的数据加载**（普通模式）：
   - 在调用 `fetchProducts` 之前，先 `setProducts([])`
   - 这确保了用户看到加载状态而不是旧数据

**注意**：在"我喜欢"/"为您推荐"模式下选择款式/色系时，**不清空数据**，因为是前端过滤，可以立即显示结果。

### useEffect 依赖项说明

主加载 useEffect 的依赖项为：`[mounted, fetchProducts, selectedStyle, selectedColor, searchQuery]`

- ✅ 包含：`selectedStyle`, `selectedColor`, `searchQuery` - 真正的筛选条件，变化时重新加载
- ❌ 不包含：`showLikedOnly`, `showSharedOnly` - 这些由按钮点击独立处理，避免重复请求
- ❌ 不包含：`searchParams` - URL 参数不决定是否加载，只由状态 `showSharedOnly` 控制

**关键逻辑**：

- 只检查 `showSharedOnly` 状态，不检查 URL 中是否有 `shared` 参数
- 这样当用户从"为您推荐"切换到款式/色系筛选时，即使 URL 中仍有分享ID，也能正常加载数据
- 分享模式的初始化由独立的 useEffect（第199-230行）处理

## 筛选组合矩阵

| 模式 | 款式/色系 | 数据获取方式 | 筛选方式 |
|------|-----------|------------|---------|
| 普通 | 无 | API分页查询 | 无筛选 |
| 普通 | 有 | API分页查询（带筛选参数） | 数据层筛选 |
| 为您推荐 | 无 | `fetchSharedProducts` | 只显示分享的商品 |
| 为您推荐 | 有 | `fetchSharedProducts` | 分享商品 + 前端款式/色系过滤 |
| 我喜欢 | 无 | 不请求（使用已加载数据） | 只显示喜欢的商品 |
| 我喜欢 | 有 | 不请求（使用已加载数据） | 喜欢商品 + 前端款式/色系过滤 |

### 用户体验优势

1. **符合直觉**：在推荐的10个商品中筛选花束，而不是突然跳到所有商品
2. **保持上下文**：不会丢失"推荐"或"喜欢"的筛选范围
3. **即时响应**：推荐/喜欢模式下的款式/色系筛选是前端过滤，无需等待网络请求
