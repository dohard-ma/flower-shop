<view class="profile-gradient rounded-lg overflow-hidden">
    <view class="p-40">
        <!-- 1. 用户信息 -->
        <view class="flex items-center justify-between mb-40">
            <view class="flex items-center gap-20">
                <view class="relative">
                    <view class="avatar-ring p-4">
                        <image
                            src="{{isLoggedIn ? (userInfo.avatar || defaultAvatar) : defaultAvatar}}"
                            class="rounded-full"
                            style="width: 128rpx; height: 128rpx;"
                            mode="aspectFill"
                        />
                    </view>
                    <view wx:if="{{isLoggedIn && userInfo.badge}}" class="avatar-badge">
                        <text class="text-white text-xs">{{userInfo.badge}}</text>
                    </view>
                </view>
                <view bind:tap="{{!isLoggedIn ? 'showLogin' : ''}}">
                    <view class="flex items-center gap-10 mb-4">
                        <text class="text-xl font-bold text-white">{{isLoggedIn ? userInfo.nickname : '点击登录/注册'}}</text>
                        <view wx:if="{{isLoggedIn && userInfo.level}}" class="user-level">
                            <text class="text-xs font-bold">{{userInfo.level}}</text>
                        </view>
                    </view>
                    <text class="text-xs" style="color: rgba(255, 255, 255, 0.4);">{{isLoggedIn ? 'ID: ' + userInfo.displayId : '发现更多精彩内容'}}</text>
                </view>
            </view>
            <view wx:if="{{isLoggedIn}}" class="edit-icon" bind:tap="onEdit">
                <text class="text-lg" style="color: rgba(255, 255, 255, 0.8);">✏️</text>
            </view>
        </view>
        <!-- 2. 等级信息 -->
        <view wx:if="{{isLoggedIn && levelInfo.title}}" class="mb-30">
            <view class="flex justify-between items-center mb-10">
                <text class="text-xs font-bold" style="color: rgba(255, 255, 255, 0.9);">{{levelInfo.title}}</text>
                <text class="text-xs" style="color: rgba(255, 255, 255, 0.4);">
                    成长值 {{levelInfo.current}} / {{levelInfo.total}}
                </text>
            </view>
            <view class="h-8 rounded-sm overflow-hidden" style="background: rgba(255, 255, 255, 0.1);">
                <view class="progress-fill h-full" style="width: {{levelInfo.percent}}%;"></view>
            </view>
        </view>
    </view>
</view>

<!-- 3. 登录弹窗 -->
<t-popup visible="{{showLoginPopup}}" placement="bottom" bind:visible-change="onPopupVisibleChange" shape="round">
    <view class="login-popup bg-white rounded-t-3xl overflow-hidden relative">
        <view class="absolute right-20 top-20 z-10 p-20" bind:tap="closeLoginPopup">
            <t-icon name="close" size="40rpx" color="#ccc" />
        </view>

        <view class="px-50 pt-50 pb-60 mt-30">
            <view class="mb-40 text-center">
                <view class="text-xl font-bold text-main">完善资料</view>
                <view class="text-xs text-placeholder mt-10">请设置头像和昵称以开启服务</view>
            </view>

            <view class="flex justify-center mb-60">
                <button class="avatar-wrapper p-0 m-0 bg-none border-none" open-type="chooseAvatar" bind:chooseavatar="onChooseAvatar">
                    <view class="w-160 h-160 rounded-3xl bg-gray border-1 flex items-center justify-center overflow-hidden" style="border-style: dashed; border-color: #ddd;">
                        <image wx:if="{{tempAvatar}}" class="w-full h-full" src="{{tempAvatar}}" mode="aspectFill" />
                        <t-icon wx:else name="camera" size="64rpx" color="#bbb" />
                    </view>
                </button>
            </view>

            <view class="mb-60">
                <view class="flex items-center py-30 border-b">
                    <text class="text-base font-bold text-main" style="width: 128rpx;">昵称</text>
                    <t-input
                        class="flex-1 nickname-input"
                        placeholder="获取微信昵称"
                        type="nickname"
                        value="{{tempNickname}}"
                        bind:change="onNicknameChange"
                        borderless
                        custom-style="padding: 0; font-size: 28rpx; color: #333; font-weight: 500;"
                        placeholder-style="color: #bbb; font-weight: normal;"
                    />
                </view>

                <view class="flex items-center py-30 border-b relative">
                    <text class="text-base font-bold text-main" style="width: 128rpx;">手机号</text>
                    <view class="flex-1">
                        <button
                            class="phone-button font-medium {{tempPhone ? 'text-main' : 'text-placeholder'}}"
                            open-type="getPhoneNumber"
                            bind:getphonenumber="onGetPhoneNumber"
                        >
                            {{tempPhone || '获取微信手机号'}}
                        </button>
                    </view>
                </view>
            </view>

            <view class="flex items-center gap-20 mb-60" bind:tap="toggleAgreement">
                <t-checkbox
                    checked="{{isAgreed}}"
                    icon="circle"
                    borderless
                    class="agreement-checkbox"
                    style="pointer-events: none;"
                />
                <view class="text-sm text-placeholder flex items-center">
                    同意 <text class="text-main font-medium mx-10">《服务协议》</text> 及 <text class="text-main font-medium mx-10">《隐私保护》</text>
                </view>
            </view>

            <t-button
                theme="primary"
                block
                size="large"
                loading="{{isSubmitting}}"
                disabled="{{!tempAvatar || !tempNickname || !tempPhoneCode || !isAgreed}}"
                bind:tap="onLoginSubmit"
            >保存资料并登录</t-button>
        </view>

        <view class="h-40"></view>
    </view>
</t-popup>